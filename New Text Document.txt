
            mdecSmsTokenLifeTime = SystemConfigurationInstance.GetConfigurationItem<decimal>(SystemConfigurationInstance.SmsTokenLifetime);
            var strPhoneNumber = "-";

            var objUserInstance = new UsersInstance()
            {
                SearchAllMode = true,
                USER_ID = mdecUserId
            };
            objUserInstance.SearchGetFirstObject();

            if (!string.IsNullOrEmpty(objUserInstance.OBJID))
            {
                if (!string.IsNullOrEmpty(objUserInstance.USER_PHONE))
                {
                    strPhoneNumber = objUserInstance.USER_PHONE;

                    var strToken = CreateToken();

                    if (SendSmsCode(strPhoneNumber, strToken))
                    {
                        objUserInstance.SMS_TOKEN = strToken;
                        objUserInstance.SMS_TOKEN_CREATE_DATE = DateTime.Now;

                        objUserInstance.Save();
                    }
                }
                else
                {
                    ShowError(General.InvalidCellPhoneNumber);
                }
            }
            else
            {
                ShowError(General.UserDoesNotExist);
            }

            var strLast3DigitsOfPhoneNumber = strPhoneNumber;

            if (strPhoneNumber.Length > 3)
            {
                strLast3DigitsOfPhoneNumber = strPhoneNumber.Substring(strPhoneNumber.Length - 3);
            }

            lblSmsInfo.Text = String.Format(General.SmsLoginMessage, strLast3DigitsOfPhoneNumber);
            lblSmsInfoReminder.Text = String.Format(General.SmsLoginMessageReminder, mdecSmsTokenLifeTime);
        }





        private string CreateToken()
        {
            var objRandom = new Random();
            var objCode = objRandom.Next(10000, 99999);
            var strCode = objCode.ToString("00000");

            return strCode;
        }



        private bool SendSmsCode(string strDestination, string strCode)
        {
            var strMessageTemplate = SystemConfigurationInstance.GetConfigurationItem<string>(SystemConfigurationInstance.SmsTokenMessage);

            var strMessage = string.Format(strMessageTemplate, strCode);

            var strResult = StarNet.API.Utils.Utils.SendSMS(strDestination, strMessage, true);

            if (!string.IsNullOrEmpty(strResult))
            {
                ShowError(strResult);

                return false;
            }

            return true;
        }

SMS_TOKEN_LIFETIME
תוקף קוד זיהוי SMS בדקות

SMS_TOKEN_MESSAGE
תבנית SMS קוד זיהוי

קוד הזיהוי שלך למערכת הינו: {0}




                if (objUserInstance.SMS_TOKEN == txtSmsCode.Text)
                {
                    if (objUserInstance.SMS_TOKEN_CREATE_DATE.AddMinutes((double)mdecSmsTokenLifeTime) >= DateTime.Now)
                    {
                        mblnIsCorrectToken = true;
                        this.DialogResult = Gizmox.WebGUI.Forms.DialogResult.OK;
                        this.Close();
                    }
                    else
                    {
                        ShowError(General.SmsCodeOutdated);
                    }
                }
                else
                {
                    ShowError(General.SmsCodeInvalid);
                }